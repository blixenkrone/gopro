name: gopro build/test flow
on:
  push:
    branches:
      - master

# 1. Test local code
# 1a. Clone it to company repo
# 2. Build docker image img:tag
# 3. Push docker image img:tag to docker hub
# 4. SSH into linux server
# 5. copy/paste/replace local docker-compose.yml on linux server (it's gitignored)
# 6. inside server > Docker pull img:tag
# 7. docker-compose up -d

jobs:
  development:
    name: review and build code for dev env
    runs-on: ubuntu-latest
    steps:
      - name: Checkout to master
        uses: actions/checkout@master

      - name: Set up go v1.13
        uses: actions/setup-go@v1
        with:
          go-version: "1.13" # The Go version to download (if necessary) and use.
        id: go

      # - name: Go test
      #   run: go test ./...

      - name: Go vet
        run: go vet

      - name: Login to DockerHub Registry
        run: echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
      - name: Build the Docker image
        run: docker build --rm -f "Dockerfile" -t byrdapp/gopro:prod .
      - name: Push the Docker image to the registry
        run: docker push byrdapp/pro-app:dev

  production:
    name: review and build code for prod env
    runs-on: ubuntu-latest
    steps:
      # - uses: actions/checkout@master ?
      - name: Checkout to master
        uses: actions/checkout@master

      - name: Set up go v1.13
        uses: actions/setup-go@v1
        with:
          go-version: "1.13" # The Go version to download (if necessary) and use.
        id: go

      # - name: Go test
      #   run: go test ./...

      - name: Go vet cmd
        run: go vet cmd/gopro/main.go

      - name: Login to DockerHub Registry
        run: echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
      - name: Build the Docker image
        run: docker build --rm -f "Dockerfile" -t byrdapp/gopro:prod .
      - name: Push the Docker image to the registry
        run: docker push byrdapp/pro-app:dev
